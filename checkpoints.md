# PR Reviewer Assignment Service (Тестовое задание Авито, осень 2025)

Микросервис для автоматического назначения ревьюверов на Pull Request’ы, управления командами и активностью пользователей. Взаимодействие происходит исключительно через HTTP API (см. `openapi.yml`).

## Технологический стек

- Язык: Go
- База данных: PostgreSQL (по ТЗ рекомендована; фактический выбор описать здесь)
- Запуск: через `docker-compose up` (сервис на порту `8080`)

## Структура домена (по ТЗ)

- **User** — участник команды:
  - `user_id` — уникальный идентификатор
  - `username`
  - `is_active` — флаг активности
- **Team** — группа пользователей:
  - `team_name` — уникальное имя
  - список участников
- **Pull Request (PR)**:
  - `pull_request_id`
  - `pull_request_name`
  - `author_id`
  - `status`: `OPEN | MERGED`
  - `assigned_reviewers` — до 2 ревьюверов

## Чеклист реализации / текущий статус

### 1. Доменные модели и слои

- [x] Определить доменные модели `User` и `Team` (структуры в пакете `model`).
- [x] Определить доменную модель `PullRequest` с полями по `openapi.yml`.
- [x] Ввести пакеты `errs` для разных слоёв (репозиторий/сервис) с явными перечислениями ошибок.
- [x] Реализовать базовый сервисный слой для команд:
  - интерфейс `TeamService`
  - методы `CreateTeam` и `GetTeam`.
- [x] Реализовать сервисный слой для пользователей (`UserService`).
- [x] Реализовать сервисный слой для PR (`PullRequestService`):
  - создание PR;
  - merge (идемпотентный);
  - переназначение ревьювера;
  - выборка PR по ревьюверу.

### 2. Слой хранения данных (репозитории)

- [x] Описать интерфейсы `TeamRepository` и `UserRepository`.
- [x] Описать интерфейс `PullRequestRepository`.
- [x] Реализовать репозиторий команд (PostgreSQL / выбранная БД):
  - создание команды;
  - проверка существования по имени;
  - получение команды с участниками.
- [x] Реализовать репозиторий пользователей:
  - создание/обновление пользователя (upsert);
  - получение по `user_id`;
  - обновление флага `is_active`.
- [x] Реализовать репозиторий PR:
  - создание PR;
  - сохранение статуса `OPEN/MERGED`;
  - привязка ревьюверов;
  - выборка PR по ревьюверу.
- [x] Добавить типовые ошибки репозитория (`ErrNotFound`, `ErrDuplicate`, `ErrConstraint`) и использовать их в сервисном слое для маппинга в доменные ошибки.

### 3. Бизнес-логика назначения ревьюверов

- [x] При создании PR (**/pullRequest/create**):
  - находить автора;
  - определять его команду;
  - выбирать **до двух** активных ревьюверов из команды автора, **исключая автора**;
  - если доступных кандидатов меньше двух — назначать 0/1 ревьювера;
  - не назначать пользователей с `is_active = false`.
- [x] При переназначении ревьювера (**/pullRequest/reassign**):
  - убедиться, что PR существует и не в статусе `MERGED`;
  - убедиться, что `old_user_id` действительно назначен ревьювером этого PR;
  - выбрать случайного активного участника из команды **старого ревьювера**;
  - заменить старого ревьювера на нового;
  - если в команде нет активных кандидатов — вернуть доменную ошибку `NO_CANDIDATE`.
- [x] После статуса `MERGED`:
  - запретить изменение списка ревьюверов;
  - при попытке переназначения возвращать `PR_MERGED` (HTTP 409).
- [x] Учесть, что пользователь с `is_active = false` никогда не должен назначаться ревьювером (ни при создании PR, ни при переназначении).

### 4. HTTP API (по `openapi.yml`)

#### 4.1 Команды

- [x] **POST /team/add**
  - Создать новую команду с участниками.
  - Если команда уже существует — вернуть `400` + `error.code = TEAM_EXISTS`.
- [x] **GET /team/get**
  - Получить команду с участниками по `team_name` (404 при отсутствии).

#### 4.2 Пользователи

- [x] **POST /users/setIsActive**
  - Установить флаг активности пользователя (404 при отсутствии).
- [x] **GET /users/getReview**
  - Вернуть список PR, где пользователь назначен ревьювером (пустой список, если ничего нет).

#### 4.3 Pull Request’ы

- [x] **POST /pullRequest/create**
  - Принимать DTO, вызывать `PRService.CreatePR`, маппить `ErrUserNotFound` (404), `ErrPRExists` (409 `PR_EXISTS`), `ErrNoCandidates`.
- [x] **POST /pullRequest/merge**
  - Вызывать `Merge`, отдавать DTO, 404 при отсутствии PR.
- [x] **POST /pullRequest/reassign**
  - Вызывать `Reassign`, маппить `ErrPRMerged`, `ErrReviewerMissing`, `ErrNoCandidates` в `409` + `ErrorResponse`.

### 4.4 Документация OpenAPI

- Файл спецификации: `openapi.yml`.
- Сервис отдаёт Swagger UI по `http://localhost:8080/swagger/`. `openapi.yml` лежит в репозитории, отдельного эндпоинта на выдачу файла нет.

### 5. Обработка ошибок

- [x] Ввести отдельные наборы ошибок для сервисного и репозиторного слоёв (пакеты `errs`).
- [x] Добавить доменный тип ошибки с полем `code`, совпадающим с enum из `ErrorResponse` (`TEAM_EXISTS`, `PR_EXISTS`, `PR_MERGED`, `NOT_ASSIGNED`, `NO_CANDIDATE`).
- [x] В сервисном слое маппить:
  - технические ошибки репозитория (`ErrNotFound`, `ErrDuplicate`) → доменные;
  - доменные ошибки → коды из `ErrorResponse`.
- [x] В HTTP-слое (хэндлеры):
  - по доменному `code` выбирать HTTP-статус (400/404/409);
  - возвращать JSON в формате `ErrorResponse` из `openapi.yml`.

### 6. Нефункциональные требования

- [x] Обеспечить работу сервиса при нагрузке до 5 RPS.
- [x] Держать время ответа в пределах 300 мс (SLI).
- [x] Обеспечить успешность 99.9% для корректных запросов (за счёт устойчивости к ошибкам и аккуратной обработке).
- [x] Реализовать простое логирование запросов и ошибок.
- [x] Добавить базовое мониторинг/health-check:
  - [x]  **GET /healthcheck** (можно добавить отдельный эндпоинт или использовать существующий паттерн).

### 7. Инфраструктура и деплой

- [x] Описать Dockerfile для сервиса.
- [x] Описать `docker-compose.yml`, поднимающий:
  - сервис;
  - базу данных;
- [x] Обеспечить запуск всего проекта командой:
  - `docker-compose up`
- [x] Гарантировать, что при `docker-compose up`:
  - применяются миграции (**в нашем решении их нет**);
  - сервис доступен на порту `8080`.

### 8. Дополнительные задания (опционально)

- [x] Эндпоинт статистики:
  - [x] количество назначений ревьюверов по пользователям;
  - [x] количество назначенных ревьюверов по PR;
  - [ ] количество PR по статусам (не реализовано).
- [x] Массовая деактивация пользователей команды:
  - [x] реализовать метод массовой деактивации;
  - [x] безопасно переназначать ревьюверов в открытых PR;
  - [x] стремиться уложиться в 100 мс для средних объёмов данных (покрыто интеграционным нагрузочным тестом).
- [x] Интеграционные / E2E тесты:
  - [x] прогон основных сценариев через HTTP (`test/pr_controller_integration_test.go`);
  - [x] поднятие тестовой БД (Postgres в `test/docker-compose.integration.yml`) для прогонов.
- [ ] Конфигурация линтера (использовались дефолт gofmt от Extension Pack в VScode):
  - [ ] добавить конфиг (например, для `golangci-lint`);
  - [ ] описать команду запуска в `Makefile`.

### 9. Makefile и запуск

- [x] Makefile команды:
  - `make up` — ensure .env, swagger, build, docker-compose up -d;
  - `make run` — локальный запуск бинаря (.env);
  - `make unit-cover` / `make integration-cover` — тесты + HTML coverage;
  - `make docs` — сгенерировать swagger;
  - `make docker-build` / `docker-up` / `docker-down` — обвязка для контейнеров.
- [ ] Описать в README: требования (Go, Docker), шаги запуска (частично добавлено).
